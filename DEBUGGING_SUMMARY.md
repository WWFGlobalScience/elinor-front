# Offline Mode Bug - Debugging Summary

## Issue

Even with `OFFLINE_MODE=false` in CI/CD environment variables, the application was running in offline mode, skipping API calls and using cached data.

### Symptoms

```javascript
// From browser console:
[onload middleware] offlineModeEnabled: true ❌
[onload middleware] layout.offlineModeEnabled: true ❌
[onload middleware] app.$config.offlineMode: false ✓
[onload middleware] process.env.OFFLINE_MODE: undefined
[onload middleware] Skipping dispatch - offline mode enabled ❌
```

The store state showed `true` while the runtime config showed `false` - a contradiction.

---

## Debugging Process

### Step 1: Initial Hypothesis (Wrong ❌)

**"Store initializes at build-time with stale values"**

The initial fix tried to sync the store in the middleware:

```javascript
const runtimeOfflineModeEnabled = app.$config?.offlineMode === true || false;
store.commit('layout/setOfflineModeEnabled', runtimeOfflineModeEnabled);
```

✓ This was correct, BUT it wasn't the complete fix. The app was still not working.

### Step 2: Discovery (The Real Issue ✓)

Investigated the persistence layer and found `plugins/vuex-persist.js` which automatically:

1. **Restores state from localStorage** on page load
2. **Persists all changes** back to localStorage

```javascript
// This was persisting the OLD offlineModeEnabled value from localStorage!
reducer: (state) => {
  return state;  // ← Persisting everything, including stale offlineModeEnabled
}
```

### Step 3: The Real Root Cause

**Timeline of the bug:**

```
Day 1 (Build with undefined OFFLINE_MODE):
├─ Store init: offlineModeEnabled = false (default)
├─ Build completes
└─ localStorage saves: { layout: { offlineModeEnabled: false } }

Day 2 (Build with undefined/stale OFFLINE_MODE):
├─ Store init: offlineModeEnabled = false (default)
├─ localStorage has old value
├─ Middleware syncs with runtime config ← Works!
└─ But then vuex-persist re-saves the same OLD value

User Browser (After deployment with OFFLINE_MODE=false):
├─ Page loads
├─ localStorage has STALE VALUE: offlineModeEnabled = true (from old build)
├─ Store initializes: offlineModeEnabled = false
├─ vuex-persist HYDRATES from localStorage: offlineModeEnabled = true ← BUG!
├─ Middleware syncs: offlineModeEnabled = false ← Temporarily fixes
├─ Component uses store value: offlineModeEnabled = true ← But this persists!
├─ Next page load: localStorage still has true ← INFINITE LOOP
└─ Result: Offline mode stuck ON despite OFFLINE_MODE=false env var
```

### Step 4: Solution

**Stop persisting configuration values to localStorage**

The fix prevents `offlineModeEnabled` from being persisted:

```javascript
// In vuex-persist.js reducer:
if (stateCopy.layout) {
  const { offlineModeEnabled, ...layoutPropertiesToPersist } = stateCopy.layout;
  stateCopy.layout = layoutPropertiesToPersist;  // ← Exclude offlineModeEnabled
}
```

And ensure the default is always `false`:

```javascript
// In store/layout.js:
export const state = () => ({
  offlineModeEnabled: false,  // ← Was: isOfflineModeEnabled()
});
```

---

## Key Insights

### 1. Configuration ≠ State

**Configuration** (environment variables, feature flags) should NOT be persisted to localStorage because:
- It changes based on deployment/environment
- Stale cached values override current deployment
- Creates impossible debugging scenarios

**User State** (preferences, selections, progress) should be persisted because:
- It's generated by user actions
- Persisting improves UX
- Is independent of deployments

### 2. Plugin Load Order Matters

In Nuxt, plugins run early and can override later logic:

```
1. Plugins initialize (including vuex-persist)
   └─ Restores old state from localStorage
2. Middleware runs
   └─ Tries to sync with current config
3. Components render
   └─ But persistence plugin auto-saves everything again!
```

### 3. Explicit Over Computed

Instead of:
```javascript
offlineModeEnabled: isOfflineModeEnabled()  // ← Computed at module load
```

Use:
```javascript
offlineModeEnabled: false  // ← Explicit default
```

Because computed values at module load time are:
- Hard to debug
- Captured at build time
- Vulnerable to stale persistence

### 4. Single Source of Truth

Configuration should flow from one source:

```
OFFLINE_MODE env var
         ↓
nuxt.config.js publicRuntimeConfig
         ↓
app.$config.offlineMode (at runtime)
         ↓
store.state.layout.offlineModeEnabled (synced in middleware)
         ↓
All components read from store
```

NOT from multiple competing sources like:
- Direct env var access
- Multiple store modules
- Computed values
- Multiple local storage keys

---

## Changes Made

### File: `plugins/vuex-persist.js`

**Added** (lines 64-71):
```javascript
// CRITICAL: Exclude offlineModeEnabled from persistence
if (stateCopy.layout) {
  const { offlineModeEnabled, ...layoutPropertiesToPersist } = stateCopy.layout;
  stateCopy.layout = layoutPropertiesToPersist;
}
```

**Reason**: Prevents localStorage from persisting stale configuration values

---

### File: `store/layout.js`

**Changed** (line 9):
```javascript
// FROM:
offlineModeEnabled: isOfflineModeEnabled(),

// TO:
offlineModeEnabled: false,
```

**Reason**: Explicit default instead of computed value that captures build-time environment

---

### File: `middleware/onload.js` (Already Present)

**Already had** (lines 9-14):
```javascript
const runtimeOfflineModeEnabled = app.$config?.offlineMode === true || false;
store.commit('layout/setOfflineModeEnabled', runtimeOfflineModeEnabled);
```

**Reason**: Syncs store with runtime config before any component logic runs

---

## Testing Strategy

### ✅ Verify in CI/CD

```bash
# Set in GitLab CI/CD variables:
OFFLINE_MODE=false

# Expected logs:
[onload middleware] SYNCED offlineModeEnabled: false ✓
[onload middleware] app.$config.offlineMode: false ✓
[onload middleware] Dispatching actions - offline mode disabled ✓

# Expected behavior:
✓ API calls are made
✓ Assessments, attributes, survey questions are fetched
✓ No "Skipping dispatch" messages
✓ App functions normally
```

### ✅ Clear Browser Cache

Since the fix prevents persistence of `offlineModeEnabled`, users may need to:
1. Clear localStorage
2. Or just do a fresh page load (new session)

The fresh session will initialize with `false` and stay correct.

### ✅ Verify Opposite Works

```bash
OFFLINE_MODE=true

# Expected:
[onload middleware] offlineModeEnabled: true ✓
[onload middleware] Skipping dispatch - offline mode enabled ✓
```

---

## Prevention

### Code Review Checklist

- [ ] Config values are not computed at module load
- [ ] Config values are not persisted to localStorage  
- [ ] Configuration has single source (e.g., app.$config)
- [ ] Store is synced with config in middleware/plugins
- [ ] Default values are explicit, not computed

### Future Similar Issues

If you see:
- "Feature flag not responding to environment variables"
- "Setting doesn't update despite deployment"
- "Old value keeps coming back"

Think: **"Is this being persisted when it shouldn't be?"**

---

## References

- `OFFLINE_MODE_FIX.md` - Initial fix (incomplete, but explains build-time issue)
- `OFFLINE_MODE_ROOT_CAUSE.md` - Complete root cause analysis
- `plugins/vuex-persist.js` - State persistence plugin
- `store/layout.js` - Layout store module
- `middleware/onload.js` - Route middleware that syncs config
- `nuxt.config.js` - Runtime config definition
